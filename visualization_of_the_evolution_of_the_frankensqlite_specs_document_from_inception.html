<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <!-- Deploy Hash: 2026-02-08-PREMIUM-DARK-V2 -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>FrankenSQLite | Spec Reanimation</title>
    
    <!-- OpenGraph & Favicon -->
    <meta property="og:title" content="FrankenSQLite Spec Evolution" />
    <meta property="og:description" content="137 commits · 10,791 lines · 12 sessions of architectural reanimation." />
    <meta property="og:image" content="og-image.png" />
    <meta name="twitter:card" content="summary_large_image" />
    <link rel="icon" type="image/webp" href="frankensqlite_illustration.webp" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700;800&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
    <style>
        :root {
            /* Premium Dark Palette */
            --bg: #050505;
            --surface-1: #0A0A0A;
            --surface-2: #121212;
            --surface-3: #1E1E1E;
            --border: #2A2A2A;
            --border-highlight: #3A3A3A;
            
            --primary: #39ff14; /* Keeping brand green */
            --primary-dim: rgba(57, 255, 20, 0.1);
            --primary-glow: rgba(57, 255, 20, 0.3);

            /* Legacy accent tokens still referenced in HUD/error overlays */
            --accent: #ff003c;
            --electric: #00f2ff;
            
            --text-primary: #EDEDED;
            --text-secondary: #A0A0A0;
            --text-tertiary: #606060;
            
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
            
            --glass-bg: rgba(10, 10, 10, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --backdrop-blur: blur(12px);
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.4);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.5);
            --shadow-lg: 0 24px 48px rgba(0,0,0,0.6);
            
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --transition-fast: 0.15s cubic-bezier(0.2, 0, 0, 1);
            --transition-smooth: 0.3s cubic-bezier(0.2, 0, 0, 1);
        }

        * { box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        
        body {
            background-color: var(--bg);
            color: var(--text-primary);
            font-family: var(--font-sans);
            margin: 0;
            overflow: hidden;
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* --- Layout Structure --- */
        .main-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
            background: radial-gradient(circle at top center, #111 0%, var(--bg) 60%);
        }

        .app-header {
            height: 60px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            flex-shrink: 0;
            z-index: 100;
            position: relative;
        }

        .brand { display: flex; align-items: center; gap: 12px; }
        .brand img { height: 32px; border-radius: 6px; box-shadow: 0 0 10px rgba(57,255,20,0.1); }
        .brand h1 { font-size: 14px; font-weight: 600; color: var(--text-primary); letter-spacing: -0.01em; margin: 0; }
        .brand h1 span { color: var(--text-secondary); font-weight: 400; margin-left: 8px; }

        .app-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* --- Optional "Lab Effects" (must never crash core rendering) --- */
        .data-packet {
            position: fixed;
            width: 6px;
            height: 6px;
            border-radius: 999px;
            background: rgba(57, 255, 20, 0.95);
            box-shadow: 0 0 12px rgba(57, 255, 20, 0.35);
            pointer-events: none;
            z-index: 9997;
        }

        /* --- Sidebar (Commit List) --- */
        .sidebar {
            width: 360px;
            background: var(--surface-1);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 50;
            transition: transform var(--transition-smooth);
        }

        .sidebar-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            background: var(--surface-1);
        }
        
        .sidebar-header input {
            width: 100%;
            background: var(--surface-2);
            border: 1px solid var(--border);
            padding: 10px 12px;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 13px;
            border-radius: var(--radius-sm);
            outline: none;
            transition: all var(--transition-fast);
        }
        
        .sidebar-header input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-dim);
        }
        
        .sidebar-header input::placeholder { color: var(--text-tertiary); }

        .commit-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .commit-card {
            background: transparent;
            border: 1px solid transparent;
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .commit-card:hover {
            background: var(--surface-2);
            border-color: var(--border);
        }

        .commit-card.selected {
            background: var(--surface-2);
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .commit-card-header {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-tertiary);
            font-family: var(--font-mono);
            margin-bottom: 4px;
        }

        .commit-card-subject {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .commit-card.selected .commit-card-subject { color: var(--text-primary); }

        .commit-card-meta {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg);
            overflow: hidden;
            position: relative;
        }

        .content-header {
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            background: var(--surface-1);
        }

        .tabs { display: flex; gap: 4px; background: var(--surface-2); padding: 3px; border-radius: var(--radius-sm); border: 1px solid var(--border); }
        .tab {
            padding: 6px 14px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: 4px;
            transition: all var(--transition-fast);
        }
        .tab:hover { color: var(--text-primary); }
        .tab.active { background: var(--surface-3); color: var(--text-primary); box-shadow: var(--shadow-sm); }

        .viewport { flex: 1; position: relative; overflow: hidden; }
        
        .scroll-pane { 
            height: 100%; 
            overflow-y: auto; 
            padding: 40px; 
            -webkit-overflow-scrolling: touch; 
        }

        .spec-container {
            max-width: 800px;
            margin: 0 auto;
            color: var(--text-secondary);
            padding-bottom: 100px;
        }

        .spec-content {
            font-family: var(--font-sans);
            font-size: 16px;
            line-height: 1.7;
            color: var(--text-secondary);
            overflow-x: hidden;
            word-wrap: break-word;
            overflow-wrap: anywhere; 
        }

        .spec-content h1, .spec-content h2, .spec-content h3 {
            color: var(--text-primary);
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-top: 2em;
        }
        
        .spec-content h1 { border-bottom: 1px solid var(--border); padding-bottom: 0.5em; font-size: 24px; }
        .spec-content h2 { font-size: 20px; }
        
        .spec-content code {
            font-family: var(--font-mono);
            background: var(--surface-2);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #E6E6E6;
        }
        
        .spec-content pre {
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 16px;
            overflow-x: auto;
            margin: 1.5em 0;
        }

        /* --- Dock --- */
        .dock {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            border-top: 1px solid var(--glass-border);
            padding: 16px 24px calc(16px + env(safe-area-inset-bottom));
            z-index: 100;
        }

        .evolution-map { 
            height: 48px; 
            background: var(--surface-2); 
            border-radius: var(--radius-sm); 
            position: relative; 
            margin-bottom: 16px; 
            border: 1px solid var(--border); 
            overflow: hidden;
        }
        
        .map-canvas { width: 100%; height: 100%; display: block; opacity: 0.8; }
        .map-slider { position: absolute; inset: 0; width: 100%; height: 100%; -webkit-appearance: none; background: transparent; margin: 0; z-index: 10; cursor: crosshair; }
        .map-slider:focus { outline: none; }
        .map-slider::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            width: 4px; 
            height: 48px; 
            background: #fff; 
            box-shadow: 0 0 15px rgba(255,255,255,0.5); 
            border-radius: 2px;
            cursor: ew-resize;
        }

        .dock-bottom { display: flex; align-items: center; justify-content: space-between; gap: 20px; }
        
        .btn-lab {
            background: var(--surface-2); 
            border: 1px solid var(--border); 
            color: var(--text-secondary); 
            font-family: var(--font-mono);
            font-weight: 600; 
            padding: 8px 16px; 
            border-radius: var(--radius-sm); 
            font-size: 11px; 
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        .btn-lab:hover { background: var(--surface-3); color: var(--text-primary); border-color: var(--border-highlight); }
        .btn-lab:active { transform: translateY(1px); }

        .btn-play { display: none !important; }

        /* --- Mobile Overrides --- */
        .mobile-only { display: none !important; }
        
        @media (max-width: 768px) {
            .mobile-only { display: block !important; }
            .mobile-hide { display: none !important; }
            
            /* Sidebar becomes a drawer */
            .sidebar {
                position: absolute;
                top: 0; bottom: 0; left: 0;
                width: 85%;
                max-width: 320px;
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
                border-right: 1px solid var(--glass-border);
            }
            .sidebar.active { transform: translateX(0); }
            
            /* Add backdrop for sidebar */
            .sidebar.active::before {
                content: "";
                position: fixed;
                inset: 0;
                left: 320px; /* Offset by sidebar width */
                width: 100vw;
                background: rgba(0,0,0,0.5);
                backdrop-filter: blur(4px);
                z-index: -1;
            }

            .app-header { padding: 0 16px; height: 56px; }
            .content-header { padding: 0 16px; overflow-x: auto; }
            .scroll-pane { padding: 20px 16px; }
            
            .dock { padding: 12px 16px calc(12px + env(safe-area-inset-bottom)); }
            .evolution-map { height: 60px; /* Taller touch target */ }
            .map-slider::-webkit-slider-thumb { width: 20px; height: 60px; background: rgba(255,255,255,0.2); box-shadow: none; border-left: 2px solid #fff; border-right: 2px solid #fff; }
            
            .brand h1 span { display: none; }
        }

        /* --- Utilities --- */
        .hidden { display: none !important; }
        #loadingOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .vital-pulse { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Cleanup unwanted elements */
        .system-hud, .dna-hud, .metrics-hud, #flashlight, .aberration, .arc-container { display: none !important; }
    </style>
</head>
<body data-flashlight="true">

<!-- SVG Filter Pipeline -->
<svg style="position: absolute; width: 0; height: 0;" aria-hidden="true" focusable="false">
  <defs>
    <filter id="crt-filter">
      <!-- Barrel Distortion -->
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="5" xChannelSelector="R" yChannelSelector="G" />
      
      <!-- Chromatic Aberration -->
      <feOffset in="SourceGraphic" dx="1.5" dy="0" result="red-chan" />
      <feOffset in="SourceGraphic" dx="-1.5" dy="0" result="blue-chan" />
      <feColorMatrix in="red-chan" type="matrix" values="1 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 1 0" result="r" />
      <feColorMatrix in="blue-chan" type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 1 0 0  0 0 0 1 0" result="b" />
      <feColorMatrix in="SourceGraphic" type="matrix" values="0 0 0 0 0  0 1 0 0 0  0 0 0 0 0  0 0 0 1 0" result="g" />
      <feBlend in="r" in2="g" mode="screen" result="rg" />
      <feBlend in="rg" in2="b" mode="screen" />
    </filter>
    
    <filter id="glow-filter">
      <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
      <feMerge>
        <feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/>
      </feMerge>
    </filter>
  </defs>
</svg>

<div class="lab-grid"></div>
<div id="flashlight"></div>

<svg class="arc-container" id="arcContainer" viewBox="0 0 1000 1000" preserveAspectRatio="none">
    <path id="arcPath" class="electric-arc" d="" />
</svg>

<div class="system-hud" id="systemHud">
    <div style="display: flex; justify-content: center; margin-bottom: 12px; border-bottom: 1px dashed var(--border); padding-bottom: 8px;">
        <svg class="hud-brain" viewBox="0 0 24 24" id="hudBrain">
            <path d="M12,2C7.58,2,4,5.58,4,10c0,2.42,1.08,4.59,2.78,6.06C6.29,16.5,6,17.21,6,18c0,1.66,1.34,3,3,3h6c1.66,0,3-1.34,3-3 c0-0.79-0.29-1.5-0.78-1.94C18.92,14.59,20,12.42,20,10C20,5.58,16.42,2,12,2z M9,19c-0.55,0-1-0.45-1-1s0.45-1,1-1s1,0.45,1,1 S9.55,19,9,19z M15,19c-0.55,0-1-0.45-1-1s0.45-1,1-1s1,0.45,1,1S15.55,19,15,19z"/>
            <circle id="brainLogic" class="brain-glow" cx="12" cy="8" r="3" />
            <circle id="brainEng" class="brain-glow" cx="8" cy="12" r="2" />
            <circle id="brainArch" class="brain-glow" cx="16" cy="12" r="2" />
        </svg>
    </div>
    <div class="hud-row">
        <span>NEURAL_LOAD</span>
        <div class="hud-bar"><div id="hudLoad" class="hud-fill"></div></div>
    </div>
    <div class="hud-row">
        <span>SYNC_STATE</span>
        <span id="hudSync" style="color: var(--electric);">STABLE</span>
    </div>
    <div class="hud-row">
        <span>TISSUE_INTEGRITY</span>
        <div class="hud-bar"><div id="hudIntegrity" class="hud-fill"></div></div>
    </div>
    <div class="hud-row" style="margin-top: 8px; border-top: 1px dashed var(--border); padding-top: 8px;">
        <span>CORE_TEMP</span>
        <span id="hudTemp">36.5°C</span>
    </div>
    <div class="hud-row">
        <span>VOLTAGE</span>
        <span id="hudVoltage">240V</span>
    </div>
</div>

<div id="loadingOverlay">
    <div class="vital-pulse"></div>
    <div style="font-family: var(--font-mono); font-size: 11px; color: var(--text-secondary); margin-top: 24px; letter-spacing: 0.1em; font-weight: 500;">INITIALIZING</div>
</div>

<div class="main-container" id="mainContainer">
    <header class="app-header">
    <div class="brand">
        <button class="btn-lab mobile-only" id="btnOpenLogs" style="margin-right: 12px;">LOGS</button>
        <img src="frankensqlite_illustration.webp" alt="Logo">
        <h1>FrankenSQLite<span>Evolutionary DNA</span></h1>
    </div>
    <div class="kpis" style="display: flex; gap: 30px;">
        <div style="display: flex; flex-direction: column;"><span style="font-size: 10px; font-weight: 600; color: var(--text-tertiary); letter-spacing: 0.05em;">ENTRIES</span><span id="kpiCommits" style="font-size: 13px; font-weight: 600; color: var(--text-primary);">-</span></div>
        <div style="display: flex; flex-direction: column;"><span style="font-size: 10px; font-weight: 600; color: var(--text-tertiary); letter-spacing: 0.05em;">MASS</span><span id="kpiLines" style="font-size: 13px; font-weight: 600; color: var(--text-primary);">-</span></div>
    </div>
    <button class="btn-lab mobile-hide" onclick="window.open('https://github.com/Dicklesworthstone/frankensqlite')">SOURCE</button>
</header>

<div class="app-body">
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <span style="font-size: 10px; font-weight: 800; color: var(--fg-dim); letter-spacing: 0.2em;">LABORATORY_LOGS</span>
                <button class="btn-lab mobile-only" id="btnCloseLogs">CLOSE</button>
            </div>
            <input id="searchInput" type="text" placeholder="FILTER_EVOLUTION..." style="width:100%; background:#050505; border:1px solid var(--border); padding:10px; color:var(--primary); font-family:var(--font-mono); border-radius:4px; outline:none;">
        </div>
        <div id="commitList" class="commit-list"></div>
    </aside>

    <main class="main-content">
        <div class="content-header">
            <div class="tabs">
                <div id="tabSpec" class="tab active">THE_LEDGER</div>
                <div id="tabTimeline" class="tab">DIAGNOSTICS</div>
                <div id="tabDiff" class="tab">DELTA</div>
            </div>
            <div id="activeLabel" style="font-size: 9px; font-family: var(--font-mono); color: var(--fg-dim);"></div>
        </div>

        <div class="viewport">
            <div id="viewSpec" class="scroll-pane"><div id="specContainer" class="spec-container"><div id="specContent" class="spec-content"></div></div></div>
            <div id="viewTimeline" class="hidden scroll-pane">
                <div id="chartVelocity" style="height: 250px; margin-bottom: 30px;"></div>
                <div id="chartDistribution" style="height: 250px; margin-bottom: 30px;"></div>
                <div id="chartMass" style="height: 350px;"></div>
                <div style="position: absolute; top: 20px; right: 20px;" class="tabs mobile-hide">
                    <button class="btn-lab" id="btnDay">1D</button><button class="btn-lab" id="btnHour">1H</button><button class="btn-lab" id="btn15m">15M</button><button class="btn-lab" id="btn5m">5M</button>
                </div>
            </div>
            <div id="viewDiff" class="hidden scroll-pane"><div id="diffContent"></div></div>
        </div>
    </main>
</div>

<footer class="dock">
    <div class="evolution-map">
        <canvas id="mapCanvas" class="map-canvas"></canvas>
        <input id="commitSlider" class="map-slider" type="range" min="0" max="100" value="0">
    </div>
    
    <div class="dock-bottom">
        <div style="display: flex; gap: 8px;">
            <button id="btnPrev" class="btn-lab">PREV</button>
            <button id="btnPlay" class="btn-lab btn-play">REANIMATE</button>
            <button id="btnNext" class="btn-lab">NEXT</button>
        </div>

        <div class="dna-hud">
            <div class="dna-label">Categorical_Mutation_DNA</div>
            <div id="dnaBar" class="dna-bar"></div>
        </div>

        <div class="metrics-hud">
            <div class="metric-item"><span class="metric-label">Tissue_Lines</span><span id="metricLines" class="metric-value">0</span></div>
            <div class="metric-item"><span class="metric-label">Synaptic_Tokens</span><span id="metricTokens" class="metric-value">0</span></div>
            <div class="metric-item"><span class="metric-label">Delta_Volatility</span><span id="metricLev" class="metric-value">0</span></div>
            <div class="metric-item"><span class="metric-label">Logical_Density</span><span id="metricDensity" class="metric-value">0.0</span></div>
        </div>

        <div style="text-align: right; font-family: var(--font-mono); flex: 1; overflow: hidden;" class="mobile-hide">
            <div id="dockSubject" style="font-size: 12px; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">-</div>
            <div id="dockDetails" style="font-size: 9px; color: var(--fg-dim); text-transform: uppercase;">-</div>
        </div>
    </div>
</footer>
</div>

<!-- Deps --><script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.0/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/sql-wasm.js"></script>

<script type="module">
    const DB_URL = "spec_evolution_v1.sqlite3";
    const BUCKETS = [
        { id: 1, name: "Logic", color: "#39ff14" }, { id: 2, name: "SQLite", color: "#adff2f" },
        { id: 3, name: "Async", color: "#00ff00" }, { id: 4, name: "Arch", color: "#ff003c" },
        { id: 5, name: "Meta", color: "#666" }, { id: 6, name: "Context", color: "#d946ef" },
        { id: 7, name: "Eng", color: "#00f2ff" }, { id: 8, name: "Math", color: "#bf00ff" },
        { id: 9, name: "Clarify", color: "#00ffcc" }, { id: 10, name: "Other", color: "#475569" }
    ];

    let DB = null;
    let COMMITS = [];
    let FILTERED = []; 
    let GROUPS = new Map();
    let DOC_CACHE = new Map();
    let PATCH_CACHE = new Map();
    let METRICS = [];
    let BASE_DOC = "";
    
    const STATE = { idx: 0, q: "", tab: "spec", isPlaying: false, playInterval: null, timeBucket: "day" };

    async function init() {
        try {
            const SQL = await window.initSqlJs({ locateFile: file => `https://cdn.jsdelivr.net/npm/sql.js@1.10.3/dist/${file}` });
            const res = await fetch(DB_URL);
            if (!res.ok) throw new Error("Neural Core Data Fetch Failed");
            const buf = await res.arrayBuffer();
            DB = new SQL.Database(new Uint8Array(buf));
            
            const baseRes = DB.exec("SELECT text FROM base_doc LIMIT 1");
            if (baseRes.length) BASE_DOC = baseRes[0].values[0][0];
            
            loadCommits();
            loadGroups();
            setupEventListeners();
            syncNeuralFilters();
            await computeSynapticMetrics();
            renderCommitList();
            drawSynapticMap();
            
            if (COMMITS.length > 0) {
                await selectCommit(COMMITS.length - 1);
            }
            hideLoader();
        } catch (e) {
            console.error(e);
            document.getElementById("loadingOverlay").innerHTML = `<div style="color:var(--accent); font-family:var(--font-mono); font-size:12px; text-align:center; padding:20px;">REANIMATION_FAILURE:<br>${e.message}</div>`;
        }
    }

    function loadCommits() {
        const res = DB.exec("SELECT idx, hash, short, date_iso, author, subject, add_lines, del_lines, impact, primary_bucket, labels_json FROM commits ORDER BY idx ASC");
        if (!res.length) return;
        COMMITS = res[0].values.map(r => ({ 
            idx: r[0], hash: r[1], short: r[2], date: r[3], author: r[4], 
            subject: r[5], add: r[6], del: r[7], impact: r[8], 
            primary: r[9], labels: JSON.parse(r[10]) 
        }));
        document.getElementById("commitSlider").max = COMMITS.length - 1;
        document.getElementById("kpiCommits").textContent = COMMITS.length;
    }

    function loadGroups() {
        const res = DB.exec("SELECT commit_hash, labels_json FROM change_groups");
        if (!res.length) return;
        res[0].values.forEach(r => {
            const hash = r[0];
            const labels = JSON.parse(r[1]);
            if (!GROUPS.has(hash)) GROUPS.set(hash, []);
            GROUPS.get(hash).push(...labels);
        });
    }

    async function computeSynapticMetrics() {
        let lines = BASE_DOC.split("\n");
        let prevText = BASE_DOC;
        METRICS = [];
        for (let i = 0; i < COMMITS.length; i++) {
            const p = await getPatch(i);
            if (p) lines = applySynapticPatch(lines, p);
            const text = lines.join("\n");
            const tokens = text.split(/\s+/).length;
            // Use commit impact as a proxy for volatility to avoid expensive Levenshtein calc
            const lev = (COMMITS[i] && COMMITS[i].impact) ? COMMITS[i].impact : 0; 
            METRICS.push({ lines: lines.length, tokens, lev });
            prevText = text;
            if (i % 10 === 0) DOC_CACHE.set(i, text);
        }
    }

    function synapticDistance(a, b) {
        const wa = a.split(/\s+/), wb = b.split(/\s+/);
        const m = wa.length, n = wb.length;
        if (m === 0) return n; if (n === 0) return m;
        let prev = Array.from({length: n + 1}, (_, i) => i);
        for (let i = 1; i <= m; i++) {
            let curr = [i];
            for (let j = 1; j <= n; j++) {
                curr[j] = wa[i-1] === wb[j-1] ? prev[j-1] : Math.min(prev[j-1], prev[j], curr[j-1]) + 1;
            }
            prev = curr;
        }
        return prev[n];
    }

    window.selectCommit = async function(idx) {
        STATE.idx = Math.max(0, Math.min(COMMITS.length - 1, idx));
        document.getElementById("commitSlider").value = STATE.idx;
        const c = COMMITS[STATE.idx];
        const m = METRICS[STATE.idx];
        
        const dockSubject = document.getElementById("dockSubject");
        dockSubject.textContent = c.subject;
        if(!STATE.isPlaying) decodeText(dockSubject, c.subject, 0.8);
        
        document.getElementById("dockDetails").style.color = "var(--text-tertiary)";
        document.getElementById("dockDetails").textContent = `HASH: ${c.short} // BY: ${c.author} // TIME: ${dayjs(c.date).format("MMM DD HH:mm")}`;
        document.getElementById("activeLabel").textContent = `LOG_ENTRY_${STATE.idx} // ${c.short}`;
        
        const ml = document.getElementById("metricLines");
        const mt = document.getElementById("metricTokens");
        const mev = document.getElementById("metricLev");
        const md = document.getElementById("metricDensity");
        if(ml) ml.textContent = m.lines.toLocaleString();
        if(mt) mt.textContent = m.tokens.toLocaleString();
        if(mev) mev.textContent = m.lev.toLocaleString();
        if(md) md.textContent = (m.tokens / m.lines).toFixed(2);

        renderDNA(c);
        renderCommitList();
        await updateView();
        
        const sel = document.querySelector(".commit-card.selected");
        if (sel) sel.scrollIntoView({ block: "nearest", behavior: "smooth" });
    };

    function renderDNA(c) {
        const dna = document.getElementById("dnaBar");
        dna.innerHTML = "";
        
        // Brain Glow logic
        document.querySelectorAll('.brain-glow').forEach(el => el.style.opacity = '0');
        const primary = c.primary;
        if([1, 8, 9].includes(primary)) document.getElementById('brainLogic').style.opacity = '1';
        if([7, 3, 2].includes(primary)) document.getElementById('brainEng').style.opacity = '1';
        if([4, 6, 5].includes(primary)) document.getElementById('brainArch').style.opacity = '1';

        const labels = GROUPS.get(c.hash) || c.labels;
        if (!labels.length) {
            const s = document.createElement("div"); s.className="dna-seg"; s.style.width="100%"; s.style.background=BUCKETS[9].color;
            dna.appendChild(s); return;
        }
        const counts = {}; labels.forEach(l => counts[l] = (counts[l] || 0) + 1);
        const total = labels.length;
        Object.keys(counts).forEach(l => {
            const bucket = BUCKETS.find(b => b.id == l) || BUCKETS[9];
            const s = document.createElement("div"); s.className="dna-seg";
            s.style.width = (counts[l] / total * 100) + "%";
            s.style.background = bucket.color;
            dna.appendChild(s);
        });
    }

    async function updateView() {
        if (STATE.tab === "spec") await renderSpec();
        else if (STATE.tab === "timeline") renderCharts();
        else if (STATE.tab === "diff") await renderDiff();
    }

    async function renderSpec() {
        const el = document.getElementById("specContent");
        el.innerHTML = '<div style="color: var(--primary); font-family: var(--font-mono); font-size: 11px;">RECONSTRUCTING_TISSUE...</div>';
        const text = await reconstructSnapshot(STATE.idx);
        const md = window.markdownit({ html: true, highlight: (str, lang) => (lang && hljs.getLanguage(lang)) ? hljs.highlight(str, { language: lang }).value : '' });
        el.innerHTML = DOMPurify.sanitize(md.render(text));
        document.getElementById("kpiLines").textContent = text.split("\n").length.toLocaleString();
    }

    async function reconstructSnapshot(idx) {
        if (DOC_CACHE.has(idx)) return DOC_CACHE.get(idx);
        let startIdx = 0;
        let lines = BASE_DOC.split("\n");
        for (let i = Math.floor(idx / 10) * 10; i >= 0; i -= 10) {
            if (DOC_CACHE.has(i)) {
                startIdx = i + 1;
                lines = DOC_CACHE.get(i).split("\n");
                break;
            }
        }
        for (let i = startIdx; i <= idx; i++) {
            const p = await getPatch(i);
            if (p) lines = applySynapticPatch(lines, p);
            if (i % 10 === 0 && !DOC_CACHE.has(i)) DOC_CACHE.set(i, lines.join("\n"));
        }
        const res = lines.join("\n");
        DOC_CACHE.set(idx, res);
        return res;
    }

    function applySynapticPatch(lines, patch) {
        // Use slice() instead of spread for large array safety
        const out = lines.slice();
        const patchLines = patch.split("\n");
        let offset = 0;
        for (let i = 0; i < patchLines.length; i++) {
            const line = patchLines[i];
            if (line.startsWith("@@")) {
                const m = line.match(/@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@/);
                if (m) {
                    const os = parseInt(m[1]), oc = parseInt(m[2] || "1");
                    const startPos = os - 1 + offset;
                    const newSeg = [];
                    i++;
                    while (i < patchLines.length && !patchLines[i].startsWith("@@")) {
                        const row = patchLines[i];
                        if (row.startsWith("+")) newSeg.push(row.slice(1));
                        else if (!row.startsWith("-")) newSeg.push(row.slice(1));
                        i++;
                    }
                    i--;
                    
                    // Batched splice implementation with safe chunk size
                    const CHUNK_SIZE = 5000;
                    if (newSeg.length > CHUNK_SIZE) {
                         // Remove the old segment first
                         out.splice(startPos, oc);
                         // Insert new segment in chunks
                         for (let j = 0; j < newSeg.length; j += CHUNK_SIZE) {
                             const chunk = newSeg.slice(j, j + CHUNK_SIZE);
                             out.splice(startPos + j, 0, ...chunk);
                         }
                    } else {
                         out.splice(startPos, oc, ...newSeg);
                    }
                    
                    offset += (parseInt(m[4] || "1") - oc);
                }
            }
        }
        return out;
    }

    async function getPatch(idx) {
        if (PATCH_CACHE.has(idx)) return PATCH_CACHE.get(idx);
        const res = DB.exec("SELECT patch FROM patches WHERE idx = ?", [idx]);
        const p = res.length ? res[0].values[0][0] : "";
        PATCH_CACHE.set(idx, p); return p;
    }

    async function renderDiff() {
        const el = document.getElementById("diffContent");
        const p = await getPatch(STATE.idx);
        if (!p) { el.innerHTML = "SYSTEM_STABLE: NO_DELTA"; return; }
        const diffHtml = Diff2Html.html(p, { drawFileList: false, matching: 'lines', outputFormat: 'line-by-line', colorScheme: 'dark' });
        el.innerHTML = DOMPurify.sanitize(diffHtml);
    }

    function drawSynapticMap() {
        const cvs = document.getElementById("mapCanvas");
        const ctx = cvs.getContext("2d");
        const w = cvs.width = cvs.clientWidth;
        const h = cvs.height = cvs.clientHeight;
        if (!w || !h || COMMITS.length === 0) return;
        ctx.clearRect(0, 0, w, h);
        const barW = w / COMMITS.length;
        COMMITS.forEach((c, i) => {
            const labels = GROUPS.get(c.hash) || c.labels;
            const buckets = labels.length ? labels : [10];
            const counts = {}; buckets.forEach(l => counts[l] = (counts[l] || 0) + 1);
            const total = buckets.length;
            let cy = 0;
            Object.keys(counts).forEach(l => {
                const b = BUCKETS.find(x => x.id == l) || BUCKETS[9];
                const sh = (counts[l] / total) * h;
                ctx.fillStyle = b.color; ctx.globalAlpha = 0.6;
                ctx.fillRect(i * barW, cy, barW - 1, sh);
                cy += sh;
            });
            if (c.impact > 250) { ctx.fillStyle = "#fff"; ctx.globalAlpha = 0.2; ctx.fillRect(i * barW, 0, barW - 1, h); }
        });
    }

    let charts = {};
    function renderCharts() {
        const t = { backgroundColor: 'transparent', textStyle: { fontFamily: 'JetBrains Mono', color: '#4a7a4a' }, grid: { top: 30, bottom: 30, left: 40, right: 20 }, xAxis: { axisLine: { lineStyle: { color: '#1a221a' } }, splitLine: { show: false } }, yAxis: { axisLine: { lineStyle: { color: '#1a221a' } }, splitLine: { lineStyle: { color: '#111', type: 'dashed' } } } };
        if (!charts.velocity) charts.velocity = echarts.init(document.getElementById("chartVelocity"));
        charts.velocity.setOption({ ...t, series: [{ data: COMMITS.map(c => [c.date, c.impact]), type: 'line', smooth: true, lineStyle: { color: '#39ff14' }, areaStyle: { color: 'rgba(57, 255, 20, 0.1)' } }] });
        if (!charts.dist) charts.dist = echarts.init(document.getElementById("chartDistribution"));
        const counts = {}; COMMITS.forEach(c => counts[c.primary] = (counts[c.primary] || 0) + 1);
        charts.dist.setOption({ ...t, series: [{ type: 'pie', radius: ['40%', '70%'], data: BUCKETS.map(b => ({ value: counts[b.id] || 0, name: b.name, itemStyle: { color: b.color } })) }] });
        renderMassGrowth();
    }

    function renderMassGrowth() {
        if (!charts.mass) charts.mass = echarts.init(document.getElementById("chartMass"));
        const buckets = groupCommits(STATE.timeBucket);
        const labels = Object.keys(buckets).sort();
        const series = BUCKETS.map(b => ({ name: b.name, type: 'bar', stack: 'total', itemStyle: { color: b.color }, data: labels.map(l => buckets[l][b.id] || 0) }));
        const t = { backgroundColor: 'transparent', textStyle: { fontFamily: 'JetBrains Mono', color: '#4a7a4a' }, grid: { top: 30, bottom: 30, left: 40, right: 20 }, xAxis: { axisLine: { lineStyle: { color: '#1a221a' } } }, yAxis: { axisLine: { lineStyle: { color: '#1a221a' } }, splitLine: { lineStyle: { color: '#111' } } } };
        charts.mass.setOption({ ...t, tooltip: { trigger: 'axis' }, xAxis: { type: 'category', data: labels }, series }, true);
    }

    function groupCommits(unit) {
        const res = {};
        COMMITS.forEach(c => {
            let k; const d = dayjs(c.date);
            if (unit === "day") k = d.format("YYYY-MM-DD");
            else if (unit === "hour") k = d.format("MM-DD HH:00");
            else if (unit === "15m") k = d.format("MM-DD HH:") + (Math.floor(d.minute()/15)*15).toString().padStart(2,'0');
            else k = d.format("MM-DD HH:") + (Math.floor(d.minute()/5)*5).toString().padStart(2,'0');
            if (!res[k]) res[k] = {};
            res[k][c.primary] = (res[k][c.primary] || 0) + c.impact;
        });
        return res;
    }

    function setupEventListeners() {
        document.getElementById("searchInput").addEventListener("input", e => { STATE.q = e.target.value; syncNeuralFilters(); renderCommitList(); });
        document.getElementById("commitSlider").addEventListener("input", e => selectCommit(parseInt(e.target.value)));
        
        ["Spec", "Timeline", "Diff"].forEach(t => {
            const btn = document.getElementById("tab" + t);
            btn.addEventListener("click", e => {
                ["Spec", "Timeline", "Diff"].forEach(tt => { document.getElementById("tab" + tt).classList.remove("active"); document.getElementById("view" + tt).classList.add("hidden"); });
                e.target.classList.add("active"); document.getElementById("view" + t).classList.remove("hidden");
                
                // Kinetic title reveal
                const titleMap = { "Spec": "THE_LEDGER", "Timeline": "DIAGNOSTICS", "Diff": "DELTA" };
                decodeText(btn, titleMap[t], 0.5);
                
                STATE.tab = t.toLowerCase(); updateView();
            });
        });

        ["btnDay", "btnHour", "btn15m", "btn5m"].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener("click", () => {
                STATE.timeBucket = id.replace("btn", "").toLowerCase();
                renderMassGrowth();
            });
        });

        document.getElementById("btnOpenLogs").addEventListener("click", (e) => {
            e.stopPropagation();
            document.getElementById("sidebar").classList.add("active");
        });
        
        document.getElementById("btnCloseLogs").addEventListener("click", () => document.getElementById("sidebar").classList.remove("active"));
        
        // Click outside to close sidebar on mobile
        document.addEventListener("click", (e) => {
            const sidebar = document.getElementById("sidebar");
            const btn = document.getElementById("btnOpenLogs");
            if (sidebar.classList.contains("active") && !sidebar.contains(e.target) && e.target !== btn) {
                sidebar.classList.remove("active");
            }
        });

        // Reanimate button disabled
        /*
        document.getElementById("btnPlay").addEventListener("click", () => {
             // ...
        });
        */

        document.getElementById("btnPrev").addEventListener("click", () => selectCommit(STATE.idx - 1));
        document.getElementById("btnNext").addEventListener("click", () => selectCommit(STATE.idx + 1));
        window.addEventListener("resize", () => { drawSynapticMap(); Object.values(charts).forEach(c => c.resize()); });
    }

    function syncNeuralFilters() { const q = STATE.q.toLowerCase(); FILTERED = COMMITS.filter(c => !q || c.subject.toLowerCase().includes(q) || c.hash.includes(q)); }
    
    function renderCommitList() {
        const container = document.getElementById("commitList");
        container.innerHTML = FILTERED.slice().reverse().map(c => {
            const b = BUCKETS.find(x => x.id === c.primary) || BUCKETS[9];
            const sel = c.idx === STATE.idx ? "selected" : "";
            // Use --text-tertiary instead of old --fg-dim
            return `<div class="commit-card ${sel}" onclick="window.selectCommit(${c.idx}); document.getElementById('sidebar').classList.remove('active');"><div class="commit-card-header"><span>ENT_${c.idx}</span><span style="color: var(--text-tertiary)">${dayjs(c.date).format("MMM DD")}</span></div><div class="commit-card-subject">${escapeHtml(c.subject)}</div><div class="commit-card-meta"><span style="color:${b.color}">${b.name}</span><span style="color:var(--primary)">+${c.add}</span></div></div>`;
        }).join("");
    }

    function hideLoader() {
        document.getElementById("loadingOverlay").style.opacity = '0';
        setTimeout(() => {
            document.getElementById("loadingOverlay").classList.add("hidden");
            // Start kinetic reveals
            decodeText(document.querySelector('.brand h1'), "FrankenSQLite // Evolutionary_DNA", 1.5);
            decodeText(document.querySelector('.sidebar-header span'), "LABORATORY_LOGS", 1.2, 0.5);
            startLabEffects();
        }, 500);
    }

    // --- Kinetic & Lab Effects ---

    const CHARS = "01$!@#%^&*()_+{}:<>?[]|";

	    function decodeText(element, targetText, duration = 1, delay = 0) {
	        if (!element || !targetText) return;
	        const dur = Math.max(0.01, duration);
	        setTimeout(() => {
	            let iteration = 0;
            const maxIterations = targetText.length;
            const startTime = Date.now();
            element.innerText = "";
            const interval = setInterval(() => {
                const elapsed = (Date.now() - startTime) / 1000;
                iteration = (elapsed / dur) * maxIterations;
                element.innerText = targetText.split("").map((char, index) => {
                    if (index < iteration) return targetText[index];
                    if (char === " ") return " ";
                    return CHARS[Math.floor(Math.random() * CHARS.length)];
                }).join("");
                if (iteration >= maxIterations) { clearInterval(interval); element.innerText = targetText; }
            }, 30);
	        }, delay * 1000);
	    }

	    // Optional lab effect: animated "data packets" across the UI.
	    // Must never crash the app (the viz page should render even if effects fail).
	    let LAST_PACKET_AT_MS = 0;
	    let LAB_EFFECTS_DISABLED = false;
	    let LAB_EFFECTS_DISABLE_REASON = "";

	    function logLabEffectOnce(level, event, extra) {
	        if (LAB_EFFECTS_DISABLED && event === "spec_viz_effect_disabled" && LAB_EFFECTS_DISABLE_REASON) return;
	        try {
	            const payload = Object.assign({ event, level, ts_ms: Date.now() }, extra || {});
	            // One-line JSON so Playwright/CI logs are readable.
	            console.log(JSON.stringify(payload));
	        } catch (_) {
	            // Logging must never crash the page.
	        }
	    }

	    function disableLabEffects(reason, err) {
	        LAB_EFFECTS_DISABLED = true;
	        LAB_EFFECTS_DISABLE_REASON = reason || "unknown";
	        logLabEffectOnce("info", "spec_viz_effect_disabled", {
	            effect: "lab_effects",
	            reason: LAB_EFFECTS_DISABLE_REASON,
	            error: err && err.message ? String(err.message) : undefined,
	        });
	    }

	    function isSelfTestMode() {
	        try {
	            const u = new URL(window.location.href);
	            return u.searchParams.get("selftest") === "1" || u.hash === "#selftest";
	        } catch (_) {
	            return false;
	        }
	    }

	    function prefersReducedMotion() {
	        try {
	            return window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
	        } catch (_) {
	            return false;
	        }
	    }

	    function setSelfTestSentinel(ok, err) {
	        const id = "specVizSelftestSentinel";
	        let el = document.getElementById(id);
	        if (!el) {
	            el = document.createElement("div");
	            el.id = id;
	            el.style.cssText = "position:fixed;left:-9999px;top:-9999px;font-family:monospace;font-size:12px;";
	            document.body.appendChild(el);
	        }
	        el.textContent = ok ? "SPEC_VIZ_SELFTEST_PASS" : "SPEC_VIZ_SELFTEST_FAIL";
	        logLabEffectOnce("info", "spec_viz_selftest", {
	            result: ok ? "pass" : "fail",
	            error: err && err.message ? String(err.message) : undefined,
	        });
	    }

	    function createDataPacket() {
	        if (LAB_EFFECTS_DISABLED) return;
	        try {
	            const now = performance.now();
	            // Throttle to avoid DOM churn on high-FPS displays.
	            if (now - LAST_PACKET_AT_MS < 120) return;
	            LAST_PACKET_AT_MS = now;

	            const packet = document.createElement("div");
	            packet.className = "data-packet";
	            const w = window.innerWidth || 0;
	            const h = window.innerHeight || 0;
	            const margin = 20;
	            const startFromLeft = Math.random() < 0.5;
	            const startX = startFromLeft ? -margin : (w + margin);
	            const startY = margin + Math.random() * Math.max(0, h - (margin * 2));
	            const endX = startFromLeft ? (w + margin) : -margin;
	            const endY = margin + Math.random() * Math.max(0, h - (margin * 2));

	            packet.style.left = startX + "px";
	            packet.style.top = startY + "px";
	            document.body.appendChild(packet);

	            const dx = endX - startX;
	            const dy = endY - startY;
	            const dur = 600 + Math.random() * 900;
	            const t0 = performance.now();
	            const anim = packet.animate(
	                [
	                    { transform: "translate(0,0)", opacity: 0.0 },
	                    { transform: "translate(0,0)", opacity: 1.0, offset: 0.12 },
	                    { transform: `translate(${dx}px, ${dy}px)`, opacity: 0.0 }
	                ],
	                { duration: dur, easing: "cubic-bezier(0.2,0.8,0.2,1)", fill: "forwards" }
	            );
	            anim.onfinish = () => {
	                try { packet.remove(); } catch (_) {}
	                const dt = performance.now() - t0;
	                logLabEffectOnce("debug", "spec_viz_create_data_packet", { duration_ms: Math.round(dt) });
	            };
	            anim.oncancel = () => { try { packet.remove(); } catch (_) {} };
	        } catch (e) {
	            disableLabEffects("exception", e);
	        }
	    }

	    function startLabEffects() {
	        try {
	            const selftest = isSelfTestMode();
	            if (!selftest && prefersReducedMotion()) return;
	            if (LAB_EFFECTS_DISABLED) return;

	            if (selftest) {
	                try {
	                    createDataPacket();
	                    setSelfTestSentinel(true);
	                } catch (e) {
	                    setSelfTestSentinel(false, e);
	                }
	                return;
	            }

	            function packetLoop() {
	                if (LAB_EFFECTS_DISABLED) return;
	                try {
	                    if (document.visibilityState === "visible" && Math.random() > 0.98) createDataPacket();
	                } catch (e) {
	                    disableLabEffects("exception", e);
	                    return;
	                }
	                requestAnimationFrame(packetLoop);
	            }
	            packetLoop();
	        } catch (e) {
	            disableLabEffects("exception", e);
	        }
	    }

    function updateSystemHud() { return; }

    function maybeSpark() { return; }

    function createElectricArc() { return; }

    function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }

    init();
</script>
</body>
</html>
